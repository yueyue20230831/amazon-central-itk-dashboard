<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon Central ITK Dashboard - å®Œæ•´æ•°æ®ç‰ˆ (å¸¦ç™»å½•)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .login-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .error-message {
            color: #dc3545;
            margin-top: 10px;
            font-size: 14px;
        }

        /* ä¸»ç•Œé¢æ ·å¼ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .header .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* ç®¡ç†å‘˜ä¸“ç”¨æ ·å¼ */
        .admin-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .admin-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .upload-area {
            border: 2px dashed #ffc107;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #fffbf0;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #e0a800;
            background: #fff8e1;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #f8fff8;
        }

        .file-input {
            display: none;
        }

        .content {
            padding: 30px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .asin-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 300px;
        }

        .asin-links {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-width: 350px;
        }

        .asin-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            text-decoration: none;
            transition: all 0.3s;
        }

        .asin-tag:hover {
            background: #1976d2;
            color: white;
        }

        .asin-link {
            background: #fff3cd;
            color: #856404;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 11px;
            text-decoration: none;
            transition: all 0.3s;
            border: 1px solid #ffeaa7;
        }

        .asin-link:hover {
            background: #856404;
            color: white;
            transform: translateY(-1px);
        }

        .metric-value {
            font-weight: 600;
            color: #495057;
        }

        .percentage {
            color: #28a745;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .header .stats {
                gap: 20px;
            }
            
            .stat-number {
                font-size: 1.5em;
            }
            
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .user-info {
                position: static;
                justify-content: center;
                margin-top: 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .header .subtitle {
                font-size: 1em;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>ITK Dashboard ç™»å½•</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">ç™»å½•</button>
                <div id="loginError" class="error-message"></div>
            </form>
            <div style="margin-top: 20px; font-size: 14px; color: #6c757d;">
                <p>æµ‹è¯•è´¦å·ï¼š</p>
                <p>ç®¡ç†å‘˜: admin / admin123</p>
                <p>ç”¨æˆ·: user / user123</p>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainPage" class="container">
        <div class="header">
            <div class="user-info">
                <span id="userBadge" class="user-badge"></span>
                <button id="logoutBtn" class="logout-btn">é€€å‡ºç™»å½•</button>
            </div>
            <h1>ğŸ¯ Amazon Central ITK Dashboard</h1>
            <div class="subtitle">å®Œæ•´æ•°æ®åˆ†æ - F2é›†æˆç‰ˆæœ¬</div>
            <div class="stats">
                <div class="stat-item">
                    <span id="totalRecords" class="stat-number">0</span>
                    <span class="stat-label">æ€»è®°å½•æ•°</span>
                </div>
                <div class="stat-item">
                    <span id="totalASINs" class="stat-number">0</span>
                    <span class="stat-label">ASINæ•°é‡</span>
                </div>
                <div class="stat-item">
                    <span id="totalGV" class="stat-number">$0</span>
                    <span class="stat-label">æ€»GV</span>
                </div>
                <div class="stat-item">
                    <span id="totalOrders" class="stat-number">0</span>
                    <span class="stat-label">æ€»è®¢å•æ•°</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <!-- ç®¡ç†å‘˜ä¸“ç”¨åŒºåŸŸ -->
            <div id="adminSection" class="admin-section">
                <h3>ğŸ”§ ç®¡ç†å‘˜åŠŸèƒ½</h3>
                <div class="upload-area" id="uploadArea">
                    <div>
                        <strong>ğŸ“ ä¸Šä¼ æ•°æ®æ–‡ä»¶</strong>
                        <p>æ‹–æ‹½CSVæˆ–Excelæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                        <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                            æ”¯æŒæ ¼å¼: .csv, .xlsx, .xls
                        </p>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls">
                </div>
                <div class="action-buttons">
                    <button id="uploadBtn" class="btn btn-warning">ğŸ“¤ é€‰æ‹©æ–‡ä»¶ä¸Šä¼ </button>
                    <button id="resetDataBtn" class="btn btn-secondary">ğŸ”„ é‡ç½®æ•°æ®</button>
                    <button id="exportDataBtn" class="btn btn-success">ğŸ“Š å¯¼å‡ºå½“å‰æ•°æ®</button>
                </div>
            </div>

            <div class="search-filters">
                <div class="filter-group">
                    <label for="searchInput">ğŸ” æœç´¢</label>
                    <input type="text" id="searchInput" placeholder="æœç´¢PTã€ITKæˆ–ASIN...">
                </div>
                <div class="filter-group">
                    <label for="ptFilter">äº§å“ç±»å‹ (PT)</label>
                    <select id="ptFilter">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="itkFilter">ITKç±»åˆ«</label>
                    <select id="itkFilter">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="priceFilter">ä»·æ ¼å¸¦</label>
                    <select id="priceFilter">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
            </div>

            <div class="action-buttons">
                <button id="applyFilters" class="btn btn-primary">ğŸ” åº”ç”¨ç­›é€‰</button>
                <button id="clearFilters" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…é™¤ç­›é€‰</button>
                <button id="downloadPPT" class="btn btn-success">ğŸ“Š ç”ŸæˆPPTæŠ¥å‘Š</button>
                <button id="downloadCSV" class="btn btn-warning">ğŸ“¥ ä¸‹è½½CSV</button>
            </div>
        </div>

        <div class="content">
            <div id="loadingIndicator" class="loading">
                æ­£åœ¨åŠ è½½æ•°æ®...
            </div>

            <div id="tableContainer" style="display: none;">
                <h2 style="margin-bottom: 20px; color: #495057;">ğŸ“Š è¯¦ç»†æ•°æ®è¡¨æ ¼</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>äº§å“ç±»å‹ (PT)</th>
                            <th>ITKç±»åˆ«</th>
                            <th>ä»·æ ¼å¸¦</th>
                            <th>ASP</th>
                            <th>GV</th>
                            <th>è®¢å•æ•°</th>
                            <th>ASINæ•°é‡</th>
                            <th>æ¨èASIN</th>
                            <th>ASINé“¾æ¥</th>
                            <th>ITKå æ¯”</th>
                            <th>é€‰å“PPT</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        // å…¨å±€å˜é‡
        let dashboardData = null;
        let filteredData = null;
        let charts = {};
        let currentUser = null;

        // ç”¨æˆ·è´¦å·é…ç½®
        const users = {
            'admin': {
                password: 'admin123',
                role: 'admin',
                name: 'ç®¡ç†å‘˜'
            },
            'user': {
                password: 'user123',
                role: 'user',
                name: 'æ™®é€šç”¨æˆ·'
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainPage();
                loadDashboardData();
            } else {
                showLoginPage();
            }

            // ç»‘å®šç™»å½•è¡¨å•äº‹ä»¶
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // ç»‘å®šç®¡ç†å‘˜åŠŸèƒ½äº‹ä»¶
            if (currentUser && currentUser.role === 'admin') {
                setupAdminFeatures();
            }

            // ç»‘å®šå…¶ä»–äº‹ä»¶
            setupEventListeners();
        }

        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainPage').style.display = 'none';
        }

        // æ˜¾ç¤ºä¸»é¡µé¢
        function showMainPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            const userBadge = document.getElementById('userBadge');
            userBadge.textContent = `${currentUser.name} (${currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'})`;
            
            // æ˜¾ç¤º/éšè—ç®¡ç†å‘˜åŠŸèƒ½
            const adminSection = document.getElementById('adminSection');
            if (currentUser.role === 'admin') {
                adminSection.style.display = 'block';
                setupAdminFeatures();
            } else {
                adminSection.style.display = 'none';
            }
        }

        // å¤„ç†ç™»å½•
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
            if (users[username] && users[username].password === password) {
                currentUser = {
                    username: username,
                    role: users[username].role,
                    name: users[username].name
                };
                
                // ä¿å­˜ç™»å½•çŠ¶æ€
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // æ˜¾ç¤ºä¸»é¡µé¢
                showMainPage();
                loadDashboardData();
                
                errorDiv.textContent = '';
            } else {
                errorDiv.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
            }
        }

        // å¤„ç†ç™»å‡º
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoginPage();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').textContent = '';
        }

        // è®¾ç½®ç®¡ç†å‘˜åŠŸèƒ½
        function setupAdminFeatures() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const resetDataBtn = document.getElementById('resetDataBtn');
            const exportDataBtn = document.getElementById('exportDataBtn');

            // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadBtn.addEventListener('click', () => fileInput.click());

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileUpload);

            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload({ target: { files: files } });
                }
            });

            // é‡ç½®æ•°æ®
            resetDataBtn.addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ¢å¤åˆ°é»˜è®¤æ•°æ®é›†ã€‚')) {
                    localStorage.removeItem('uploadedData');
                    loadDashboardData();
                    alert('æ•°æ®å·²é‡ç½®');
                }
            });

            // å¯¼å‡ºæ•°æ®
            exportDataBtn.addEventListener('click', exportCurrentData);
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                alert('è¯·é€‰æ‹©CSVæˆ–Excelæ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    let data;
                    if (fileName.endsWith('.csv')) {
                        data = parseCSV(event.target.result);
                    } else {
                        // å¯¹äºExcelæ–‡ä»¶ï¼Œè¿™é‡Œéœ€è¦é¢å¤–çš„åº“æ¥è§£æ
                        alert('Excelæ–‡ä»¶è§£æåŠŸèƒ½éœ€è¦é¢å¤–çš„åº“æ”¯æŒï¼Œè¯·ä½¿ç”¨CSVæ ¼å¼');
                        return;
                    }

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (validateUploadedData(data)) {
                        // ä¿å­˜ä¸Šä¼ çš„æ•°æ®
                        localStorage.setItem('uploadedData', JSON.stringify(data));
                        loadDashboardData();
                        alert(`æˆåŠŸä¸Šä¼  ${data.length} æ¡è®°å½•`);
                    } else {
                        alert('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                    }
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æé”™è¯¯:', error);
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }
            };
            reader.readAsText(file);
        }

        // è§£æCSVæ•°æ®
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            return data;
        }

        // éªŒè¯ä¸Šä¼ çš„æ•°æ®æ ¼å¼
        function validateUploadedData(data) {
            if (!Array.isArray(data) || data.length === 0) return false;
            
            const requiredFields = ['PT', 'ITK', 'price_band', 'GV', 'Order_Units'];
            const firstRow = data[0];
            
            return requiredFields.every(field => field in firstRow);
        }

        // å¯¼å‡ºå½“å‰æ•°æ®
        function exportCurrentData() {
            if (!filteredData || filteredData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const csvContent = convertToCSV(filteredData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `itk_dashboard_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // è½¬æ¢ä¸ºCSVæ ¼å¼
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ç­›é€‰æŒ‰é’®
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            
            // ä¸‹è½½æŒ‰é’®
            document.getElementById('downloadPPT').addEventListener('click', generatePPTReport);
            document.getElementById('downloadCSV').addEventListener('click', downloadFilteredCSV);
            
            // æœç´¢æ¡†å›è½¦äº‹ä»¶
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
        }

        // åŠ è½½Dashboardæ•°æ®
        function loadDashboardData() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';

            // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ çš„æ•°æ®
            const uploadedData = localStorage.getItem('uploadedData');
            if (uploadedData) {
                try {
                    dashboardData = JSON.parse(uploadedData);
                    processData();
                } catch (error) {
                    console.error('è§£æä¸Šä¼ æ•°æ®å¤±è´¥:', error);
                    loadDefaultData();
                }
            } else {
                loadDefaultData();
            }
        }

        // åŠ è½½é»˜è®¤æ•°æ®
        function loadDefaultData() {
            // è¿™é‡Œä½¿ç”¨å†…åµŒçš„é»˜è®¤æ•°æ®
            dashboardData = getDefaultData();
            processData();
        }

        // å¤„ç†æ•°æ®
        function processData() {
            if (!dashboardData || dashboardData.length === 0) {
                document.getElementById('loadingIndicator').innerHTML = 'æ²¡æœ‰å¯ç”¨æ•°æ®';
                return;
            }

            // åˆå¹¶ç›¸åŒPTã€ITKå’Œprice_bandçš„æ•°æ®
            const mergedData = mergeDataByConditions(dashboardData);
            filteredData = mergedData;
            
            updateStatistics();
            updateFilters();
            updateCharts();
            updateTable();
            
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
        }

        // åˆå¹¶ç›¸åŒæ¡ä»¶çš„æ•°æ®
        function mergeDataByConditions(data) {
            const groupedData = {};
            
            data.forEach(item => {
                const key = `${item.PT || 'Unknown'}_${item.ITK || 'Unknown'}_${item.price_band || 'Unknown'}`;
                
                if (!groupedData[key]) {
                    groupedData[key] = {
                        PT: item.PT,
                        ITK: item.ITK,
                        price_band: item.price_band,
                        PT_ç±»å‹: item.PT_ç±»å‹,
                        ITK_å æ¯”: item.ITK_å æ¯” || 0,
                        ASP: parseFloat(item.ASP) || 0,
                        BA: parseInt(item.BA) || 0,
                        GV: parseFloat(item.GV) || 0,
                        AWAGV: parseInt(item.AWAGV) || 0,
                        AWAS: parseInt(item.AWAS) || 0,
                        Order_Units: parseInt(item.Order_Units) || 0,
                        Discoverability_BA_AWAGV: item.Discoverability_BA_AWAGV || 0,
                        Conversion_AWAGV_AWAS: item.Conversion_AWAGV_AWAS || 0,
                        BA_AWAS_Ratio: item.BA_AWAS_Ratio || 0,
                        Productivity_Units_AWAS: item.Productivity_Units_AWAS || 0,
                        recommended_asins: [],
                        asin_details: [],
                        record_count: 0
                    };
                } else {
                    // ç´¯åŠ æ•°å€¼å­—æ®µ
                    groupedData[key].GV += parseFloat(item.GV) || 0;
                    groupedData[key].Order_Units += parseInt(item.Order_Units) || 0;
                    groupedData[key].BA += parseInt(item.BA) || 0;
                    groupedData[key].AWAGV += parseInt(item.AWAGV) || 0;
                    groupedData[key].AWAS += parseInt(item.AWAS) || 0;
                }
                
                // åˆå¹¶ASINæ•°æ®
                if (item.recommended_asins && Array.isArray(item.recommended_asins)) {
                    item.recommended_asins.forEach(asin => {
                        if (!groupedData[key].recommended_asins.includes(asin)) {
                            groupedData[key].recommended_asins.push(asin);
                        }
                    });
                }
                
                // åˆå¹¶ASINè¯¦ç»†ä¿¡æ¯
                if (item.asin_details && Array.isArray(item.asin_details)) {
                    item.asin_details.forEach(detail => {
                        const existingDetail = groupedData[key].asin_details.find(d => d.asin === detail.asin);
                        if (!existingDetail) {
                            groupedData[key].asin_details.push(detail);
                        }
                    });
                }
                
                groupedData[key].record_count++;
            });
            
            // è®¡ç®—å¹³å‡å€¼å’Œæ›´æ–°è®¡æ•°
            Object.values(groupedData).forEach(group => {
                group.asin_count = group.recommended_asins.length;
                if (group.record_count > 1) {
                    group.ASP = group.GV / group.Order_Units || 0;
                    // é‡æ–°è®¡ç®—æ¯”ç‡
                    group.Discoverability_BA_AWAGV = group.AWAGV / group.BA || 0;
                    group.Conversion_AWAGV_AWAS = group.AWAS / group.AWAGV || 0;
                    group.BA_AWAS_Ratio = group.AWAS / group.BA || 0;
                    group.Productivity_Units_AWAS = group.Order_Units / group.AWAS || 0;
                }
            });
            
            return Object.values(groupedData);
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const totalRecords = filteredData.length;
            const totalASINs = filteredData.reduce((sum, item) => sum + (item.asin_count || 0), 0);
            const totalGV = filteredData.reduce((sum, item) => sum + (parseFloat(item.GV) || 0), 0);
            const totalOrders = filteredData.reduce((sum, item) => sum + (parseInt(item.Order_Units) || 0), 0);

            document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
            document.getElementById('totalASINs').textContent = totalASINs.toLocaleString();
            document.getElementById('totalGV').textContent = '$' + totalGV.toLocaleString();
            document.getElementById('totalOrders').textContent = totalOrders.toLocaleString();
        }

        // æ›´æ–°ç­›é€‰å™¨é€‰é¡¹
        function updateFilters() {
            const ptSet = new Set();
            const itkSet = new Set();
            const priceSet = new Set();

            dashboardData.forEach(item => {
                if (item.PT) ptSet.add(item.PT);
                if (item.ITK) itkSet.add(item.ITK);
                if (item.price_band) priceSet.add(item.price_band);
            });

            updateSelectOptions('ptFilter', Array.from(ptSet).sort());
            updateSelectOptions('itkFilter', Array.from(itkSet).sort());
            updateSelectOptions('priceFilter', Array.from(priceSet).sort());
        }

        // æ›´æ–°é€‰æ‹©æ¡†é€‰é¡¹
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // æ¸…é™¤ç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"å…¨éƒ¨"é€‰é¡¹ï¼‰
            select.innerHTML = '<option value="">å…¨éƒ¨</option>';
            
            // æ·»åŠ æ–°é€‰é¡¹
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const ptFilter = document.getElementById('ptFilter').value;
            const itkFilter = document.getElementById('itkFilter').value;
            const priceFilter = document.getElementById('priceFilter').value;

            filteredData = dashboardData.filter(item => {
                const matchesSearch = !searchTerm || 
                    (item.PT && item.PT.toLowerCase().includes(searchTerm)) ||
                    (item.ITK && item.ITK.toLowerCase().includes(searchTerm)) ||
                    (item.recommended_asins && item.recommended_asins.some(asin => 
                        asin.toLowerCase().includes(searchTerm)));
                
                const matchesPT = !ptFilter || item.PT === ptFilter;
                const matchesITK = !itkFilter || item.ITK === itkFilter;
                const matchesPrice = !priceFilter || item.price_band === priceFilter;

                return matchesSearch && matchesPT && matchesITK && matchesPrice;
            });

            updateStatistics();
            updateCharts();
            updateTable();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('ptFilter').value = '';
            document.getElementById('itkFilter').value = '';
            document.getElementById('priceFilter').value = '';
            
            filteredData = [...dashboardData];
            updateStatistics();
            updateCharts();
            updateTable();
        }

        // æ›´æ–°å›¾è¡¨ï¼ˆå·²åˆ é™¤æ‰€æœ‰å›¾è¡¨ï¼‰
        function updateCharts() {
            // å›¾è¡¨å·²åˆ é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ä¸ºç©ºä»¥é¿å…é”™è¯¯
        }

        // æ›´æ–°è¡¨æ ¼
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // æ„å»ºASINåˆ—è¡¨
                const asinList = item.recommended_asins ? 
                    item.recommended_asins.slice(0, 5).map(asin => 
                        `<span class="asin-tag">${asin}</span>`
                    ).join('') : '';

                const moreAsins = item.recommended_asins && item.recommended_asins.length > 5 ? 
                    `<span class="asin-tag" style="background: #f8f9fa; color: #6c757d;">+${item.recommended_asins.length - 5} more</span>` : '';

                // æ„å»ºASINé“¾æ¥åˆ—è¡¨
                const asinLinks = item.recommended_asins ? 
                    item.recommended_asins.slice(0, 8).map(asin => 
                        `<a href="https://www.amazon.com/haul/dp/${asin}?ie=UTF8&ASIN=${asin}&s=bazaar" target="_blank" class="asin-link">${asin}</a>`
                    ).join('') : '';

                const moreLinks = item.recommended_asins && item.recommended_asins.length > 8 ? 
                    `<span class="asin-link" style="background: #f8f9fa; color: #6c757d; cursor: default;">+${item.recommended_asins.length - 8} more</span>` : '';

                row.innerHTML = `
                    <td><strong>${item.PT || 'N/A'}</strong></td>
                    <td>${item.ITK || 'N/A'}</td>
                    <td><span class="metric-value">${item.price_band || 'N/A'}</span></td>
                    <td><span class="metric-value">$${parseFloat(item.ASP || 0).toFixed(2)}</span></td>
                    <td><span class="metric-value">$${parseFloat(item.GV || 0).toLocaleString()}</span></td>
                    <td><span class="metric-value">${parseInt(item.Order_Units || 0).toLocaleString()}</span></td>
                    <td><span class="metric-value">${item.asin_count || 0}</span></td>
                    <td>
                        <div class="asin-list">
                            ${asinList}
                            ${moreAsins}
                        </div>
                    </td>
                    <td>
                        <div class="asin-links">
                            ${asinLinks}
                            ${moreLinks}
                        </div>
                    </td>
                    <td><span class="percentage">${((item.ITK_å æ¯” || 0) * 100).toFixed(1)}%</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="generateDetailedPPT(${index})">
                            ğŸ“Š é€‰å“PPT
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ç”ŸæˆPPTæŠ¥å‘Š
        function generatePPTReport() {
            if (!filteredData || filteredData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ç”ŸæˆæŠ¥å‘Š');
                return;
            }

            // åˆ›å»ºPPTå†…å®¹
            const pptContent = generatePPTContent(filteredData);
            
            // ä¸‹è½½PPTæ–‡ä»¶
            const blob = new Blob([pptContent], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ITK_Dashboard_Report_${new Date().toISOString().split('T')[0]}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ç”Ÿæˆè¯¦ç»†çš„é€‰å“PPT
        function generateDetailedPPT(index) {
            const item = filteredData[index];
            if (!item) return;

            const pptContent = generateDetailedPPTContent(item);
            
            // åˆ›å»ºå¹¶ä¸‹è½½HTMLæ–‡ä»¶
            const blob = new Blob([pptContent], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${item.PT || 'Unknown'}_${item.ITK || 'Unknown'}_${item.price_band || 'Unknown'}_é€‰å“æŒ‡å—.html`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ç”Ÿæˆè¯¦ç»†PPTå†…å®¹
        function generateDetailedPPTContent(item) {
            const currentDate = new Date().toLocaleDateString('zh-CN');
            const asinCount = item.recommended_asins ? item.recommended_asins.length : 0;
            
            // è®¡ç®—å¹³å‡è¯„åˆ†
            const avgRating = item.asin_details && item.asin_details.length > 0 ? 
                (item.asin_details.reduce((sum, detail) => sum + (parseFloat(detail.rating) || 0), 0) / item.asin_details.length).toFixed(1) : 'N/A';

            // ç”Ÿæˆäº§å“å¡ç‰‡
            const asinCards = item.asin_details && item.asin_details.length > 0 ? 
                item.asin_details.slice(0, 9).map(detail => `
                    <div class="asin-card">
                        <div class="asin-image">
                            <img src="${detail.image_url || ''}" alt="${detail.title || ''}" 
                                 onerror="this.style.display='none'; this.parentNode.innerHTML='<div style=\\'padding:15px; color:#666; font-size:12px; line-height:1.4; text-align:center; background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); border-radius: 8px; height: 120px; display: flex; flex-direction: column; justify-content: center;\\'>ğŸ“¦<br><strong style=\\'color:#FF9900\\'>äº§å“å›¾ç‰‡</strong><br><span style=\\'font-size:10px; color:#999\\'>${detail.asin}</span><br><small style=\\'color:#666; margin-top:5px\\'>${(detail.title || '').substring(0, 20)}...</small></div>';"
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                        </div>
                        <div class="asin-title">${(detail.title || '').substring(0, 60)}...</div>
                        <div class="asin-material">${detail.material || 'æè´¨ä¿¡æ¯å¾…è¡¥å……'}</div>
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">ASIN: ${detail.asin}</div>
                    </div>
                `).join('') : 
                item.recommended_asins.slice(0, 9).map(asin => `
                    <div class="asin-card">
                        <div class="asin-image">
                            <div style='padding:15px; color:#666; font-size:12px; line-height:1.4; text-align:center; background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); border-radius: 8px; height: 120px; display: flex; flex-direction: column; justify-content: center;'>ğŸ“¦<br><strong style='color:#FF9900'>äº§å“å›¾ç‰‡</strong><br><span style='font-size:10px; color:#999'>${asin}</span></div>
                        </div>
                        <div class="asin-title">äº§å“ä¿¡æ¯å¾…è¡¥å……</div>
                        <div class="asin-material">æè´¨ä¿¡æ¯å¾…è¡¥å……</div>
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">ASIN: ${asin}</div>
                    </div>
                `).join('');

            // ç”Ÿæˆæ´å¯Ÿå»ºè®®
            const insights = generateInsights(item);

            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºäº${item.ITK || 'Unknown'}çš„Amazon Haulé€‰å“å»ºè®®</title>
    <style>
        body { font-family: 'Amazon Ember', Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .slide { width: 1024px; height: 768px; margin: 20px auto; background: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); padding: 60px; box-sizing: border-box; page-break-after: always; }
        .cover-slide { background: linear-gradient(135deg, #FF9900 0%, #FF6600 100%); color: white; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .cover-slide h1 { font-size: 48px; margin-bottom: 30px; font-weight: bold; }
        .cover-slide h2 { font-size: 24px; margin-bottom: 20px; opacity: 0.9; }
        .cover-slide .date { font-size: 18px; margin-top: 40px; opacity: 0.8; }
        .slide h2 { color: #FF9900; border-bottom: 3px solid #FF9900; padding-bottom: 10px; margin-bottom: 30px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .info-item { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #FF9900; }
        .info-item h3 { color: #0F1111; margin-bottom: 10px; }
        .info-item p { color: #565959; font-size: 16px; }
        .asin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        .asin-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; border: 1px solid #ddd; }
        .asin-image { width: 150px; height: 150px; background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); border-radius: 8px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 12px; text-align: center; position: relative; overflow: hidden; }
        .asin-image::before { content: 'ğŸ–¼ï¸'; font-size: 24px; display: block; margin-bottom: 5px; }
        .asin-image img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .asin-title { font-weight: bold; margin-bottom: 8px; font-size: 14px; color: #0F1111; line-height: 1.3; }
        .asin-material { font-size: 12px; color: #565959; background: #fff3cd; padding: 4px 8px; border-radius: 4px; margin-top: 8px; }
        .analysis-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px; }
        .analysis-section { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
        .analysis-section h4 { color: #FF9900; margin-bottom: 15px; font-size: 16px; }
        .analysis-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .analysis-item:last-child { border-bottom: none; }
        .analysis-label { font-weight: 600; color: #333; }
        .analysis-value { font-weight: bold; color: #FF9900; }
        .insights-section { background: #e8f5e8; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #c3e6cb; }
        .insights-section h4 { color: #155724; margin-bottom: 15px; }
        .insights-list { list-style: none; padding: 0; margin: 0; }
        .insights-list li { padding: 8px 0; color: #155724; position: relative; padding-left: 25px; }
        .insights-list li::before { content: 'ğŸ’¡'; position: absolute; left: 0; }
        @media print { .slide { margin: 0; box-shadow: none; } }
    </style>
</head>
<body>
    <div class="slide cover-slide">
        <h1>åŸºäº${item.ITK || 'Unknown'}çš„Amazon Haulé€‰å“å»ºè®®</h1>
        <h2>Amazonå…¨çƒå¼€åº— - é€‰å“æŒ‡å¯¼æŠ¥å‘Š</h2>
        <div class="date">${currentDate}</div>
    </div>
    
    <div class="slide">
        <h2>ğŸ“Š åŸºç¡€ä¿¡æ¯</h2>
        <div class="info-grid">
            <div class="info-item"><h3>äº§å“ç±»å‹ (PT)</h3><p>${item.PT || 'N/A'}</p></div>
            <div class="info-item"><h3>å…³é”®è¯ (ITK)</h3><p>${item.ITK || 'N/A'}</p></div>
            <div class="info-item"><h3>æ¨èASINæ•°é‡</h3><p>${asinCount} ä¸ª</p></div>
            <div class="info-item"><h3>ä»·æ ¼åŒºé—´</h3><p>$${item.price_band || 'N/A'}</p></div>
        </div>
        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h3 style="color: #856404; margin-bottom: 15px;">æ¨èASINåˆ—è¡¨</h3>
            <p style="color: #856404; font-family: monospace; font-size: 14px;">${item.recommended_asins ? item.recommended_asins.join(' â€¢ ') : 'N/A'}</p>
        </div>
    </div>
    
    <div class="slide">
        <h2>ğŸ–¼ï¸ äº§å“å›¾ç‰‡å±•ç¤º</h2>
        <div class="asin-grid">
            ${asinCards}
        </div>
    </div>
    
    <div class="slide">
        <h2>ğŸ“ˆ æ•°æ®åˆ†æ</h2>
        <div class="analysis-grid">
            <div class="analysis-section">
                <h4>æµé‡æ•°æ®</h4>
                <div class="analysis-item">
                    <span class="analysis-label">å“ç‰Œåˆ†æ (BA)</span>
                    <span class="analysis-value">${(item.BA || 0).toLocaleString()}</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">æµè§ˆé‡ (AWAGV)</span>
                    <span class="analysis-value">${(item.AWAGV || 0).toLocaleString()}</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">æœç´¢é‡ (AWAS)</span>
                    <span class="analysis-value">${(item.AWAS || 0).toLocaleString()}</span>
                </div>
            </div>
            <div class="analysis-section">
                <h4>è½¬åŒ–æ•°æ®</h4>
                <div class="analysis-item">
                    <span class="analysis-label">è½¬åŒ–ç‡</span>
                    <span class="analysis-value">${((item.Conversion_AWAGV_AWAS || 0) * 100).toFixed(2)}%</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">è®¢å•é‡</span>
                    <span class="analysis-value">${(item.Order_Units || 0).toLocaleString()}</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">å¹³å‡è¯„åˆ†</span>
                    <span class="analysis-value">${avgRating}/5.0</span>
                </div>
            </div>
        </div>
        
        <div class="insights-section">
            <h4>ğŸ’¡ é€‰å“æ´å¯Ÿ</h4>
            <ul class="insights-list">
                ${insights.map(insight => `<li>${insight}</li>`).join('')}
            </ul>
        </div>
    </div>
</body>
</html>`;
        }

        // ç”Ÿæˆé€‰å“æ´å¯Ÿ
        function generateInsights(item) {
            const insights = [];
            const conversionRate = (item.Conversion_AWAGV_AWAS || 0) * 100;
            const asinCount = item.recommended_asins ? item.recommended_asins.length : 0;
            const avgRating = item.asin_details && item.asin_details.length > 0 ? 
                (item.asin_details.reduce((sum, detail) => sum + (parseFloat(detail.rating) || 0), 0) / item.asin_details.length) : 0;

            if (conversionRate < 5) {
                insights.push('è½¬åŒ–ç‡åä½ï¼Œå»ºè®®ä¼˜åŒ–äº§å“é€‰æ‹©æˆ–å®šä»·ç­–ç•¥');
            } else if (conversionRate > 15) {
                insights.push('è½¬åŒ–ç‡è¡¨ç°ä¼˜ç§€ï¼Œè¯¥ç±»ç›®å…·æœ‰è‰¯å¥½çš„å¸‚åœºæ½œåŠ›');
            }

            if (asinCount > 5) {
                insights.push(`è¯¥ç±»ç›®æœ‰${asinCount}ä¸ªæ¨èASINï¼Œé€‰æ‹©ç©ºé—´è¾ƒå¤§`);
            } else if (asinCount > 0) {
                insights.push(`è¯¥ç±»ç›®æœ‰${asinCount}ä¸ªæ¨èASINï¼Œé€‰æ‹©ç›¸å¯¹é›†ä¸­`);
            }

            if (avgRating >= 4.0) {
                insights.push('äº§å“è¯„åˆ†è¾ƒé«˜ï¼Œç”¨æˆ·æ»¡æ„åº¦è‰¯å¥½');
            } else if (avgRating >= 3.0) {
                insights.push('äº§å“è¯„åˆ†ä¸­ç­‰ï¼Œå»ºè®®å…³æ³¨äº§å“è´¨é‡');
            } else if (avgRating > 0) {
                insights.push('äº§å“è¯„åˆ†åä½ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨äº§å“è´¨é‡å’Œç”¨æˆ·ä½“éªŒ');
            }

            const orderUnits = item.Order_Units || 0;
            if (orderUnits > 1000) {
                insights.push('è®¢å•é‡è¡¨ç°å¼ºåŠ²ï¼Œå¸‚åœºéœ€æ±‚æ—ºç››');
            } else if (orderUnits > 100) {
                insights.push('è®¢å•é‡è¡¨ç°è‰¯å¥½ï¼Œå…·æœ‰ä¸€å®šå¸‚åœºåŸºç¡€');
            }

            const gv = item.GV || 0;
            const asp = item.ASP || 0;
            if (asp > 10) {
                insights.push('å¹³å‡å”®ä»·è¾ƒé«˜ï¼Œé€‚åˆè¿½æ±‚åˆ©æ¶¦ç‡çš„å–å®¶');
            } else if (asp < 5) {
                insights.push('å¹³å‡å”®ä»·è¾ƒä½ï¼Œé€‚åˆèµ°é‡å‹é”€å”®ç­–ç•¥');
            }

            if (insights.length === 0) {
                insights.push('å»ºè®®è¿›ä¸€æ­¥åˆ†æå¸‚åœºæ•°æ®ï¼Œåˆ¶å®šåˆé€‚çš„é€‰å“ç­–ç•¥');
            }

            return insights;
        }

        // ç”ŸæˆPPTå†…å®¹
        function generatePPTContent(data) {
            let content = `Amazon Central ITK Dashboard æŠ¥å‘Š\n`;
            content += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n`;
            content += `æ•°æ®è®°å½•æ•°: ${data.length}\n\n`;

            content += `=== æ•°æ®æ¦‚è§ˆ ===\n`;
            const totalGV = data.reduce((sum, item) => sum + (parseFloat(item.GV) || 0), 0);
            const totalOrders = data.reduce((sum, item) => sum + (parseInt(item.Order_Units) || 0), 0);
            const totalASINs = data.reduce((sum, item) => sum + (item.asin_count || 0), 0);

            content += `æ€»GV: $${totalGV.toLocaleString()}\n`;
            content += `æ€»è®¢å•æ•°: ${totalOrders.toLocaleString()}\n`;
            content += `æ€»ASINæ•°: ${totalASINs.toLocaleString()}\n\n`;

            content += `=== è¯¦ç»†æ•°æ® ===\n`;
            data.forEach((item, index) => {
                content += `${index + 1}. ${item.PT || 'N/A'} - ${item.ITK || 'N/A'}\n`;
                content += `   ä»·æ ¼å¸¦: ${item.price_band || 'N/A'}\n`;
                content += `   ASP: $${parseFloat(item.ASP || 0).toFixed(2)}\n`;
                content += `   GV: $${parseFloat(item.GV || 0).toLocaleString()}\n`;
                content += `   è®¢å•æ•°: ${parseInt(item.Order_Units || 0).toLocaleString()}\n`;
                content += `   ITKå æ¯”: ${((item.ITK_å æ¯” || 0) * 100).toFixed(1)}%\n`;
                if (item.recommended_asins && item.recommended_asins.length > 0) {
                    content += `   æ¨èASIN: ${item.recommended_asins.slice(0, 5).join(', ')}\n`;
                }
                content += `\n`;
            });

            return content;
        }

        // ä¸‹è½½ç­›é€‰åçš„CSV
        function downloadFilteredCSV() {
            if (!filteredData || filteredData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯ä¸‹è½½');
                return;
            }

            const csvContent = convertToCSV(filteredData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `itk_dashboard_filtered_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // è·å–é»˜è®¤æ•°æ® - å…¨é‡æ•°æ®é›† (1906æ¡è®°å½•)
        function getDefaultData() {
            // ç”±äºæ•°æ®é‡å¾ˆå¤§ï¼Œè¿™é‡Œåªè¿”å›å‰50æ¡ä½œä¸ºç¤ºä¾‹
            // å®Œæ•´æ•°æ®å¯é€šè¿‡ç®¡ç†å‘˜ä¸Šä¼ åŠŸèƒ½å¯¼å…¥
            return [
                {
                    "PT": "BLAZER",
                    "ITK": "blazers-and-sports-jackets",
                    "price_band": "10-11",
                    "PT_ç±»å‹": "åŸºç¡€PT",
                    "ITK_å æ¯”": 0.967105263,
                    "ASP": 10.0,
                    "BA": 49,
                    "GV": 14660.0,
                    "AWAGV": 47,
                    "AWAS": 32,
                    "Order_Units": 147,
                    "Discoverability_BA_AWAGV": 0.959183673,
                    "Conversion_AWAGV_AWAS": 0.680851064,
                    "BA_AWAS_Ratio": 0.653061224,
                    "Productivity_Units_AWAS": 4.59375,
                    "asin_count": 1,
                    "recommended_asins": ["B0DQW262C8"],
                    "asin_details": [{
                        "asin": "B0DQW262C8",
                        "title": "Women's Lapel Neck Lace Patch Sheer Blazer Coat Single Button Flap Night Out Party Spring Casual Office Chic Elegant Outfit",
                        "color": "Blue",
                        "material": "100% Polyester",
                        "rating": "0",
                        "image_url": "https://m.media-amazon.com/images/I/61i1KiHrglL._AC_.jpg",
                        "page_url": "https://www.amazon.com/haul/dp/B0DQW262C8?ie=UTF8&ASIN=B0DQW262C8&s=bazaar"
                    }],
                    "record_count": 1
                },
                {
                    "PT": "COORDINATED_OUTFIT",
                    "ITK": "athletic-workout-sets",
                    "price_band": "10-11",
                    "PT_ç±»å‹": "åŸºç¡€PT",
                    "ITK_å æ¯”": 0.106138107,
                    "ASP": 10.0,
                    "BA": 46,
                    "GV": 11824.0,
                    "AWAGV": 41,
                    "AWAS": 27,
                    "Order_Units": 332,
                    "Discoverability_BA_AWAGV": 0.891304348,
                    "Conversion_AWAGV_AWAS": 0.658536585,
                    "BA_AWAS_Ratio": 0.586956522,
                    "Productivity_Units_AWAS": 12.2962963,
                    "asin_count": 10,
                    "recommended_asins": ["B0DJQRJZNM", "B0DJW9SZNJ", "B0DQP3KX32", "B0DQPBN5ZT", "B0DSBM7N1G", "B0F2YY5PWG", "B0F441FXKT", "B0F7LB83FR", "B0F7LDTV11", "B0F8HJM59D"],
                    "asin_details": [
                        {
                            "asin": "B0DJQRJZNM",
                            "title": "Generic Women's Green Casual Coordinated Outfit Set: Top & Pants - Short Sleeve, High Waisted, Wide Leg",
                            "color": "Black",
                            "material": "95% Polyester, 5% Spandex",
                            "rating": "0",
                            "image_url": "https://m.media-amazon.com/images/I/71e06CUExiL._AC_SY879_.jpg",
                            "page_url": "https://www.amazon.com/haul/dp/B0DJQRJZNM?ie=UTF8&ASIN=B0DJQRJZNM&s=bazaar"
                        },
                        {
                            "asin": "B0DJW9SZNJ",
                            "title": "Generic Women's Workout Set Two-Piece for Summer Sports, Yoga, Exercise",
                            "color": "Beige",
                            "material": "90% Nylon + 10% Spandx",
                            "rating": "0",
                            "image_url": "https://m.media-amazon.com/images/I/21PRCudTmtL._AC_.jpg",
                            "page_url": "https://www.amazon.com/haul/dp/B0DJW9SZNJ?ie=UTF8&ASIN=B0DJW9SZNJ&s=bazaar"
                        }
                    ],
                    "record_count": 10
                },
                {
                    "PT": "COORDINATED_OUTFIT",
                    "ITK": "pajama-sets",
                    "price_band": "10-11",
                    "PT_ç±»å‹": "åŸºç¡€PT",
                    "ITK_å æ¯”": 0.12915601,
                    "ASP": 10.0,
                    "BA": 32,
                    "GV": 11487.0,
                    "AWAGV": 31,
                    "AWAS": 13,
                    "Order_Units": 404,
                    "Discoverability_BA_AWAGV": 0.96875,
                    "Conversion_AWAGV_AWAS": 0.419354839,
                    "BA_AWAS_Ratio": 0.40625,
                    "Productivity_Units_AWAS": 31.07692308,
                    "asin_count": 12,
                    "recommended_asins": ["B0DHKN1KCR", "B0DK44G4HV", "B0DK7FBR8B", "B0DKC1HWGX", "B0DN5QGK9Q", "B0DNZ56PKP", "B0DNZ5HBG8", "B0DP74DB4Z", "B0DPH49VL3", "B0DPKMZRD2"],
                    "asin_details": [
                        {
                            "asin": "B0DHKN1KCR",
                            "title": "Womens Pajamas Loungewear Two Piece Sleepwear Button Down Pj Shorts Matching Sets Summer Soft Set",
                            "color": "Black",
                            "material": "95% Polyester, 5% Spandex",
                            "rating": "0",
                            "image_url": "https://m.media-amazon.com/images/I/61NbJma0SmL._AC_SY879_.jpg",
                            "page_url": "https://www.amazon.com/haul/dp/B0DHKN1KCR?ie=UTF8&ASIN=B0DHKN1KCR&s=bazaar"
                        }
                    ],
                    "record_count": 12
                },
                {
                    "PT": "DRESS",
                    "ITK": "dresses",
                    "price_band": "10-11",
                    "PT_ç±»å‹": "åŸºç¡€PT",
                    "ITK_å æ¯”": 0.642156437,
                    "ASP": 10.0,
                    "BA": 882,
                    "GV": 402748.0,
                    "AWAGV": 823,
                    "AWAS": 463,
                    "Order_Units": 7397,
                    "Discoverability_BA_AWAGV": 0.933106576,
                    "Conversion_AWAGV_AWAS": 0.562575942,
                    "BA_AWAS_Ratio": 0.524943311,
                    "Productivity_Units_AWAS": 15.9762419,
                    "asin_count": 50,
                    "recommended_asins": ["B0F48FRB16", "B0F4R95MTZ", "B0F9T2NFS3"],
                    "asin_details": [
                        {
                            "asin": "B0F48FRB16",
                            "title": "Bohemian Floral V-Neck Cardigan Tie Waist Short Sleeve Dress - Vacation A-Line Sundress",
                            "color": "Black",
                            "material": "95% Polyester, 5% Spandex",
                            "rating": "0",
                            "image_url": "https://m.media-amazon.com/images/I/71eTVJ4ZNjL._AC_SY879_.jpg",
                            "page_url": "https://www.amazon.com/haul/dp/B0F48FRB16?ie=UTF8&ASIN=B0F48FRB16&s=bazaar"
                        }
                    ],
                    "record_count": 50
                }
            ];
        }

        // åŠ è½½å…¨é‡æ•°æ®çš„å‡½æ•°
        async function loadFullDataset() {
            try {
                // è¿™é‡Œå¯ä»¥é€šè¿‡AJAXåŠ è½½å®Œæ•´çš„æ•°æ®æ–‡ä»¶
                // ç”±äºæ–‡ä»¶è¾ƒå¤§ï¼Œå»ºè®®é€šè¿‡ç®¡ç†å‘˜ä¸Šä¼ åŠŸèƒ½å¯¼å…¥
                const response = await fetch('./full_dashboard_data.js');
                if (response.ok) {
                    const scriptText = await response.text();
                    // æ‰§è¡Œè„šæœ¬å¹¶è·å–æ•°æ®
                    eval(scriptText);
                    if (typeof getFullDashboardData === 'function') {
                        return getFullDashboardData();
                    }
                }
            } catch (error) {
                console.log('æ— æ³•åŠ è½½å®Œæ•´æ•°æ®é›†ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
            }
            return getDefaultData();
        }

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    </script>
</body>
</html>
